<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Users</title>
<style>
  :root{
    --accent:#0b5cff;
    --bg:#f6f7fb;
    --card:#fff;
    --muted:#6b7280;
    --shadow:0 10px 30px rgba(16,24,40,0.06);
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Arial;padding:12px;background:var(--bg);color:#111}
  header.site-header{display:flex;align-items:center;gap:12px;max-width:1100px;margin:0 auto 12px;padding:10px 12px;border-radius:10px;background:var(--card);border-bottom:1px solid #eef2f6}
  .brand{display:flex;align-items:center;gap:8px;font-weight:700}
  .brand .logo{font-size:20px}
  #mainNav{display:flex;gap:10px;align-items:center;margin-left:16px}
  #mainNav a{color:#333;text-decoration:none;padding:8px;border-radius:8px;border:1px solid transparent}
  #mainNav a.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sh-right{margin-left:auto;display:flex;align-items:center;gap:8px}
  .icon-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .hamburger{display:none;width:44px;height:44px;align-items:center;justify-content:center;border-radius:8px}
  .mobile-panel{position:fixed; top:68px; right:12px; width:320px; max-width:92vw; background:linear-gradient(180deg, rgba(255,255,255,0.98), var(--card)); border-radius:14px; box-shadow:0 24px 60px rgba(2,6,23,0.14); transform-origin:top right; transform: translateY(-12px) scale(.98); opacity:0; pointer-events:none; transition: transform .26s cubic-bezier(.2,.9,.28,1), opacity .22s ease; z-index:120; }
  .mobile-panel.open{transform:translateY(0) scale(1); opacity:1; pointer-events:auto}
  .mobile-panel .inner{padding:14px;display:flex;flex-direction:column;gap:10px}
  .mobile-panel .brand-row{display:flex;align-items:center;gap:10px;padding:8px 6px;border-bottom:1px solid #f1f5f9;margin-bottom:6px}
  .mobile-panel a{display:block;text-align:left;padding:12px 14px;border-radius:10px;color:#111;font-size:15px;text-decoration:none;transition:transform .14s ease,background .12s ease}
  .mobile-panel a:hover{background:rgba(11,92,255,0.06);transform:translateX(6px);color:var(--accent)}
  @media(max-width:900px){ #mainNav{display:none} .hamburger{display:inline-flex} }
  @media(min-width:901px){ .mobile-panel{display:none} .hamburger{display:none !important} }

  /* page */
  .card{background:var(--card);padding:16px;border-radius:10px;max-width:1100px;margin:12px auto;box-shadow:var(--shadow)}
  .row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;gap:12px}
  .left{display:flex;flex-direction:column}
  .meta{color:#666;font-size:13px}
  button.small{padding:6px 8px;border-radius:6px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .controls{display:flex;gap:8px;align-items:center}
  .muted{color:#666}
  input.search{padding:8px;border-radius:6px;border:1px solid #e6e6e6;flex:1}
</style>
</head>
<body>
  <header class="site-header">
    <div class="brand"><span class="logo">ðŸ”§</span><span>LearningHub</span></div>
    <nav id="mainNav" aria-label="Main navigation"></nav>
    <div class="sh-right">
      <div id="headerUser" class="small muted"></div>
      <button id="btnHamburger" class="icon-btn hamburger" aria-expanded="false" aria-label="Menu" title="Menu" style="margin-left:6px">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#111" stroke-width="1.6" stroke-linecap="round"/></svg>
      </button>
    </div>
  </header>

  <div id="mobileMenu" class="mobile-panel" aria-hidden="true">
    <div class="inner">
      <div class="brand-row"><span style="font-size:20px">ðŸ”§</span><div style="font-weight:700">LearningHub</div></div>
      <nav id="mobileNav" aria-label="Mobile links"></nav>
    </div>
  </div>

<div class="card">
  <h2>Manage Users</h2>

  <div class="controls" style="margin-bottom:8px">
    <input id="search" class="search" placeholder="Search name / username / email" >
    <button id="btnSearch" class="small">Search</button>
    <button id="btnRefresh" class="small">Refresh</button>
  </div>

  <div id="users">Loading...</div>
</div>

<script>
/* NAV header script (role-based links + mobile toggle) */
(function(){
  function getUserLocal(){ const s = localStorage.getItem('user'); return s ? JSON.parse(s) : null; }
  function isAdmin(u){ return u && (u.role === 'admin' || u.isAdmin); }

  function makeA(href,label){ const a = document.createElement('a'); a.href = href; a.innerText = label; return a; }

  function buildNavByRole(){
    const u = getUserLocal();
    const mainNav = document.getElementById('mainNav');
    const mobileNav = document.getElementById('mobileNav');
    if (mainNav) mainNav.innerHTML = '';
    if (mobileNav) mobileNav.innerHTML = '';

    let links = [];
    if (!u) {
      links = [{href:'index.html',label:'Lessons'},{href:'leaderboard.html',label:'Leaderboard'},{href:'history.html',label:'History'}];
    } else if (isAdmin(u)) {
      links = [
        {href:'index.html',label:'Lessons'},
        {href:'leaderboard.html',label:'Leaderboard'},
        {href:'games.html',label:'Games'},
        {href:'admin_dashboard.html',label:'Dashboard'},
        {href:'admin_users.html',label:'Users'},
        {href:'helpCenter.html',label:'Help Center'},
        {href:'history.html',label:'History'}
      ];
    } else {
      links = [
        {href:'index.html',label:'Lessons'},
        {href:'leaderboard.html',label:'Leaderboard'},
        {href:'games.html',label:'Games'},
        {href:'history.html',label:'History'},
        {href:'helpCenter.html',label:'Help Center'}
      ];
    }

    if (mainNav) {
      links.forEach(l => {
        const a = makeA(l.href, l.label);
        if (location.pathname.endsWith('admin_users.html') && l.href.includes('admin_users')) { a.style.fontWeight='700'; a.style.color='var(--accent)'; }
        mainNav.appendChild(a);
      });
    }
    if (mobileNav) {
      links.forEach(l => {
        const a = makeA(l.href, l.label); a.className='mobile-nav-link'; mobileNav.appendChild(a);
      });
    }
  }

  function renderHeaderUser(){
    const el = document.getElementById('headerUser');
    const u = getUserLocal();
    buildNavByRole();
    if (!el) return;
    if (!u) {
      el.innerHTML = '<button id="hdrLogin" class="btn-ghost small">Login</button>';
      const btn = document.getElementById('hdrLogin');
      if (btn) btn.onclick = async () => {
        const username = prompt('username'); const password = prompt('password');
        if (!username || !password) return;
        try {
          const res = await fetch('http://localhost:4000/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
          const text = await res.text(); const data = text ? JSON.parse(text) : null;
          if (!res.ok) return alert('Login failed: ' + (data && (data.error||data.message) ? (data.error||data.message) : res.statusText));
          localStorage.setItem('token', data.token); localStorage.setItem('user', JSON.stringify(data.user));
          renderHeaderUser();
        } catch(e){ alert('Login error: ' + e.message); }
      };
    } else {
      el.innerHTML = `<span style="font-weight:600">${escapeHtml(u.fullName || u.username || 'User')}</span> <button id="hdrLogout" class="btn-ghost small" style="margin-left:8px">Logout</button>`;
      const lo = document.getElementById('hdrLogout');
      if (lo) lo.onclick = ()=> { localStorage.removeItem('token'); localStorage.removeItem('user'); renderHeaderUser(); };
    }
  }

  const btn = document.getElementById('btnHamburger');
  const mobile = document.getElementById('mobileMenu');
  if (btn && mobile) {
    btn.addEventListener('click', (e) => {
      buildNavByRole();
      if (mobile.classList.contains('open')) { mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true'); }
      else { mobile.classList.add('open'); btn.setAttribute('aria-expanded','true'); mobile.setAttribute('aria-hidden','false'); }
    });
    mobile.addEventListener('click', (ev) => {
      const a = ev.target.closest('a');
      if (a && a.classList.contains('mobile-nav-link')) {
        mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('click', (ev) => {
      if (mobile && !mobile.contains(ev.target) && btn && !btn.contains(ev.target)) {
        mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') { mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true'); }});
  }

  buildNavByRole();
  renderHeaderUser();
  window._Nav = { rebuild: buildNavByRole, renderHeaderUser };
})();

/* ------------------ ORIGINAL admin_users logic (unchanged) ------------------ */

const API_BASE = 'http://localhost:4000';
async function fetchJson(url, opts={}) {
  try {
    const full = url.startsWith('http') ? url : API_BASE + url;
    const res = await fetch(full, opts);
    const text = await res.text(); let data=null;
    try{ data = text ? JSON.parse(text) : null } catch(e){ data = null }
    if (!res.ok) return { ok:false, status:res.status, error:(data && data.error) ? data.error : res.statusText, data };
    return { ok:true, data };
  } catch(err){ return { ok:false, error:err.message } }
}
function getToken(){ return localStorage.getItem('token'); }

async function load(page=1, limit=200, search=''){
  const token = getToken();
  const root = document.getElementById('users');
  if (!token) return root.innerText = 'Login as admin required';
  const qs = `?page=${page}&limit=${limit}${search ? '&search=' + encodeURIComponent(search) : ''}`;
  const r = await fetchJson('/api/admin/users' + qs, { headers: { Authorization: 'Bearer ' + token }});
  if (!r.ok) return root.innerText = r.error || 'Error';
  const users = r.data.users || [];
  if (users.length === 0) { root.innerHTML = '<div class="muted">No users found.</div>'; return; }

  let html = `<table><thead><tr><th>#</th><th>Name</th><th>Username</th><th>Points</th><th>Created</th><th>Last login</th><th>Actions</th></tr></thead><tbody>`;
  users.forEach((u, idx) => {
    const created = u.createdAt ? new Date(u.createdAt).toLocaleString() : '-';
    const last = u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '-';
    html += `<tr>
      <td>${idx+1}</td>
      <td><strong>${escapeHtml(u.fullName||'')}</strong><div class="meta">${escapeHtml(u.email||'')}</div></td>
      <td>${escapeHtml(u.username||'')}</td>
      <td>${Number(u.pointsCurrent||0)} pts</td>
      <td class="muted">${escapeHtml(created)}</td>
      <td class="muted">${escapeHtml(last)}</td>
      <td>
        <button class="small btnClear" data-id="${u._id}">Clear points</button>
        <button class="small btnDel" data-id="${u._id}">Delete</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  root.innerHTML = html;

  document.querySelectorAll('.btnDel').forEach(b => b.onclick = deleteUser);
  document.querySelectorAll('.btnClear').forEach(b => b.onclick = clearPoints);
}

async function deleteUser(e){
  const id = e.target.dataset.id;
  if (!confirm('Are you sure you want to delete this user? (soft delete)')) return;
  const token = getToken();
  const r = await fetchJson('/api/admin/users/' + encodeURIComponent(id), { method: 'DELETE', headers: { Authorization: 'Bearer ' + token }});
  if (r.ok) { alert('Deleted'); load(); } else alert(r.error || 'Error');
}

async function clearPoints(e){
  const id = e.target.dataset.id;
  if (!confirm('Clear this user points?')) return;
  const token = getToken();
  const r = await fetchJson('/api/admin/users/' + encodeURIComponent(id) + '/clear-points', { method: 'POST', headers: { Authorization: 'Bearer ' + token }});
  if (r.ok) { alert('Points cleared'); load(); } else alert(r.error || 'Error');
}

document.getElementById('btnRefresh').onclick = ()=> load();
document.getElementById('btnSearch').onclick = ()=> load(1, 200, document.getElementById('search').value.trim());
document.getElementById('search').addEventListener('keydown', (e)=> { if (e.key === 'Enter') document.getElementById('btnSearch').click(); });

load();

function escapeHtml(s){ if (s === 0) return '0'; if (!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
