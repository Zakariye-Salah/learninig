<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Users</title>
<style>
  :root{
    --accent:#0b5cff; --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --shadow:0 10px 30px rgba(16,24,40,0.06);
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Arial;padding:12px;background:var(--bg);color:#111}
  header.site-header{display:flex;align-items:center;gap:12px;max-width:1100px;margin:0 auto 12px;padding:10px 12px;border-radius:10px;background:var(--card);border-bottom:1px solid #eef2f6}
  .brand{display:flex;align-items:center;gap:8px;font-weight:700}
  .brand .logo{font-size:20px}
  #mainNav{display:flex;gap:10px;align-items:center;margin-left:16px}
  #mainNav a{color:#333;text-decoration:none;padding:8px;border-radius:8px;border:1px solid transparent}
  #mainNav a.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sh-right{margin-left:auto;display:flex;align-items:center;gap:8px}
  .icon-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .hamburger{display:none;width:44px;height:44px;align-items:center;justify-content:center;border-radius:8px}
  .mobile-panel{position:fixed; top:68px; right:12px; width:320px; max-width:92vw; background:linear-gradient(180deg, rgba(255,255,255,0.98), var(--card)); border-radius:14px; box-shadow:0 24px 60px rgba(2,6,23,0.14); transform-origin:top right; transform: translateY(-12px) scale(.98); opacity:0; pointer-events:none; transition: transform .26s cubic-bezier(.2,.9,.28,1), opacity .22s ease; z-index:120; }
  .mobile-panel.open{transform:translateY(0) scale(1); opacity:1; pointer-events:auto}
  .mobile-panel .inner{padding:14px;display:flex;flex-direction:column;gap:10px}
  .mobile-panel .brand-row{display:flex;align-items:center;gap:10px;padding:8px 6px;border-bottom:1px solid #f1f5f9;margin-bottom:6px}
  .mobile-panel a{display:block;text-align:left;padding:12px 14px;border-radius:10px;color:#111;font-size:15px;text-decoration:none;transition:transform .14s ease,background .12s ease}
  .mobile-panel a:hover{background:rgba(11,92,255,0.06);transform:translateX(6px);color:var(--accent)}
  @media(max-width:900px){ #mainNav{display:none} .hamburger{display:inline-flex} }
  @media(min-width:901px){ .mobile-panel{display:none} .hamburger{display:none !important} }

  /* page */
  .card{background:var(--card);padding:16px;border-radius:10px;max-width:1100px;margin:12px auto;box-shadow:var(--shadow)}
  .row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;gap:12px}
  .left{display:flex;flex-direction:column}
  .meta{color:#666;font-size:13px}
  button.small{padding:6px 8px;border-radius:6px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .controls{display:flex;gap:8px;align-items:center}
  .muted{color:#666}
  input.search{padding:8px;border-radius:6px;border:1px solid #e6e6e6;flex:1}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal {width:720px; max-width:94vw;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 20px 40px rgba(2,6,23,0.2)}
  .modal h3{margin:0 0 12px}
  .form-row{display:flex;gap:8px;margin-bottom:8px}
  .form-row .col{flex:1}
  .field{display:flex;flex-direction:column}
  .field label{font-size:13px;color:#333;margin-bottom:6px}
  .field input, .field select{padding:8px;border-radius:6px;border:1px solid #e6e6e6}
  .inline-msg{font-size:13px;color:#b91c1c;margin-top:6px}
</style>
</head>
<body>
  <header class="site-header">
    <div class="brand"><span class="logo">ðŸ”§</span><span>LearningHub</span></div>
    <nav id="mainNav" aria-label="Main navigation"></nav>
    <div class="sh-right">
      <div id="headerUser" class="small muted"></div>
      <button id="btnHamburger" class="icon-btn hamburger" aria-expanded="false" aria-label="Menu" title="Menu" style="margin-left:6px">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#111" stroke-width="1.6" stroke-linecap="round"/></svg>
      </button>
    </div>
  </header>

  <div id="mobileMenu" class="mobile-panel" aria-hidden="true">
    <div class="inner">
      <div class="brand-row"><span style="font-size:20px">ðŸ”§</span><div style="font-weight:700">LearningHub</div></div>
      <nav id="mobileNav" aria-label="Mobile links"></nav>
    </div>
  </div>

<div class="card">
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
    <h2 style="margin:0">Manage Users</h2>
    <div>
      <button id="btnAddUser" class="small" style="background:var(--accent);color:#fff;border-color:var(--accent)">+ Add user</button>
    </div>
  </div>

  <div class="controls" style="margin:12px 0">
    <input id="search" class="search" placeholder="Search name / username / email" >
    <button id="btnSearch" class="small">Search</button>
    <button id="btnRefresh" class="small">Refresh</button>
  </div>

  <div id="users">Loading...</div>
</div>

<!-- Add User Modal: inserted/hidden via JS -->
<div id="addUserModalWrap" style="display:none"></div>

<script>
/* NAV header + helper functions (kept from previous file) */
(function(){
  function getUserLocal(){ const s = localStorage.getItem('user'); return s ? JSON.parse(s) : null; }
  function isAdmin(u){ return u && (u.role === 'admin' || u.isAdmin); }
  function makeA(href,label){ const a = document.createElement('a'); a.href = href; a.innerText = label; return a; }

  function buildNavByRole(){
    const u = getUserLocal();
    const mainNav = document.getElementById('mainNav');
    const mobileNav = document.getElementById('mobileNav');
    if (mainNav) mainNav.innerHTML = '';
    if (mobileNav) mobileNav.innerHTML = '';
    let links = [];
    if (!u) {
      links = [{href:'index.html',label:'Lessons'},{href:'leaderboard.html',label:'Leaderboard'},{href:'history.html',label:'History'}];
    } else if (isAdmin(u)) {
      links = [
        {href:'index.html',label:'Lessons'},
        {href:'leaderboard.html',label:'Leaderboard'},
        {href:'games.html',label:'Games'},
        {href:'admin_dashboard.html',label:'Dashboard'},
        {href:'admin_users.html',label:'Users'},
        {href:'helpCenter.html',label:'Help Center'},
        {href:'history.html',label:'History'}
      ];
    } else {
      links = [
        {href:'index.html',label:'Lessons'},
        {href:'leaderboard.html',label:'Leaderboard'},
        {href:'games.html',label:'Games'},
        {href:'history.html',label:'History'},
        {href:'helpCenter.html',label:'Help Center'}
      ];
    }
    if (mainNav) {
      links.forEach(l => {
        const a = makeA(l.href, l.label);
        if (location.pathname.endsWith('admin_users.html') && l.href.includes('admin_users')) { a.style.fontWeight='700'; a.style.color='var(--accent)'; }
        mainNav.appendChild(a);
      });
    }
    if (mobileNav) {
      links.forEach(l => {
        const a = makeA(l.href, l.label); a.className='mobile-nav-link'; mobileNav.appendChild(a);
      });
    }
  }

  function renderHeaderUser(){
    const el = document.getElementById('headerUser');
    const u = getUserLocal();
    buildNavByRole();
    if (!el) return;
    if (!u) {
      el.innerHTML = '<button id="hdrLogin" class="btn-ghost small">Login</button>';
      const btn = document.getElementById('hdrLogin');
      if (btn) btn.onclick = async () => {
        const username = prompt('username'); const password = prompt('password');
        if (!username || !password) return;
        try {
          const res = await fetch('http://localhost:4000/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
          const text = await res.text(); const data = text ? JSON.parse(text) : null;
          if (!res.ok) return alert('Login failed: ' + (data && (data.error||data.message) ? (data.error||data.message) : res.statusText));
          localStorage.setItem('token', data.token); localStorage.setItem('user', JSON.stringify(data.user));
          renderHeaderUser(); load();
        } catch(e){ alert('Login error: ' + e.message); }
      };
    } else {
      el.innerHTML = `<span style="font-weight:600">${escapeHtml(u.fullName || u.username || 'User')}</span> <button id="hdrLogout" class="btn-ghost small" style="margin-left:8px">Logout</button>`;
      const lo = document.getElementById('hdrLogout');
      if (lo) lo.onclick = ()=> { localStorage.removeItem('token'); localStorage.removeItem('user'); renderHeaderUser(); load(); };
    }
  }

  const btn = document.getElementById('btnHamburger');
  const mobile = document.getElementById('mobileMenu');
  if (btn && mobile) {
    btn.addEventListener('click', (e) => {
      buildNavByRole();
      if (mobile.classList.contains('open')) { mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true'); }
      else { mobile.classList.add('open'); btn.setAttribute('aria-expanded','true'); mobile.setAttribute('aria-hidden','false'); }
    });
    mobile.addEventListener('click', (ev) => {
      const a = ev.target.closest('a');
      if (a && a.classList.contains('mobile-nav-link')) {
        mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('click', (ev) => {
      if (mobile && !mobile.contains(ev.target) && btn && !btn.contains(ev.target)) {
        mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') { mobile.classList.remove('open'); btn.setAttribute('aria-expanded','false'); mobile.setAttribute('aria-hidden','true'); }});
  }

  buildNavByRole();
  renderHeaderUser();
  window._Nav = { rebuild: buildNavByRole, renderHeaderUser };
})();

/* ------------------ admin users logic & add-user modal ------------------ */

const API_BASE = 'http://localhost:4000';
async function fetchJson(url, opts={}) {
  try {
    const full = url.startsWith('http') ? url : API_BASE + url;
    const res = await fetch(full, opts);
    const text = await res.text(); let data=null;
    try{ data = text ? JSON.parse(text) : null } catch(e){ data = null }
    if (!res.ok) return { ok:false, status:res.status, error:(data && (data.error||data.message)) ? (data.error||data.message) : res.statusText, data };
    return { ok:true, data };
  } catch(err){ return { ok:false, error:err.message } }
}
function getToken(){ return localStorage.getItem('token'); }

async function load(page=1, limit=200, search=''){
  const token = getToken();
  const root = document.getElementById('users');
  if (!token) return root.innerText = 'Login as admin required';
  const qs = `?page=${page}&limit=${limit}${search ? '&search=' + encodeURIComponent(search) : ''}`;
  const r = await fetchJson('/api/admin/users' + qs, { headers: { Authorization: 'Bearer ' + token }});
  if (!r.ok) return root.innerText = r.error || 'Error';
  const users = r.data.users || [];
  if (users.length === 0) { root.innerHTML = '<div class="muted">No users found.</div>'; return; }

  let html = `<table><thead><tr><th>#</th><th>Name</th><th>Username / Email</th><th>Role</th><th>Points</th><th>Created</th><th>Last login</th><th>Actions</th></tr></thead><tbody>`;
  users.forEach((u, idx) => {
    const created = u.createdAt ? new Date(u.createdAt).toLocaleString() : '-';
    const last = u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '-';
    html += `<tr>
      <td>${idx+1}</td>
      <td><strong>${escapeHtml(u.fullName||'')}</strong><div class="meta">${escapeHtml(u.email||'')}</div></td>
      <td>${escapeHtml(u.username||'')}</td>
      <td>${escapeHtml(u.role||'user')}</td>
      <td>${Number(u.pointsCurrent||0)} pts</td>
      <td class="muted">${escapeHtml(created)}</td>
      <td class="muted">${escapeHtml(last)}</td>
      <td>
        <button class="small btnClear" data-id="${u._id}">Clear points</button>
        <button class="small btnDel" data-id="${u._id}">Delete</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  root.innerHTML = html;

  document.querySelectorAll('.btnDel').forEach(b => b.onclick = deleteUser);
  document.querySelectorAll('.btnClear').forEach(b => b.onclick = clearPoints);
}

async function deleteUser(e){
  const id = e.target.dataset.id;
  if (!confirm('Are you sure you want to delete this user? (soft delete)')) return;
  const token = getToken();
  const r = await fetchJson('/api/admin/users/' + encodeURIComponent(id), { method: 'DELETE', headers: { Authorization: 'Bearer ' + token }});
  if (r.ok) { alert('Deleted'); load(); } else alert(r.error || 'Error');
}

async function clearPoints(e){
  const id = e.target.dataset.id;
  if (!confirm('Clear this user points?')) return;
  const token = getToken();
  const r = await fetchJson('/api/admin/users/' + encodeURIComponent(id) + '/clear-points', { method: 'POST', headers: { Authorization: 'Bearer ' + token }});
  if (r.ok) { alert('Points cleared'); load(); } else alert(r.error || 'Error');
}

document.getElementById('btnRefresh').onclick = ()=> load();
document.getElementById('btnSearch').onclick = ()=> load(1, 200, document.getElementById('search').value.trim());
document.getElementById('search').addEventListener('keydown', (e)=> { if (e.key === 'Enter') document.getElementById('btnSearch').click(); });

load();

/* ---------------- Add User Modal code ---------------- */

const modalWrap = document.getElementById('addUserModalWrap');

function openAddUserModal(prefill={}) {
  modalWrap.innerHTML = `
    <div class="modal-backdrop" id="addUserModalBackdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addUserTitle">
        <h3 id="addUserTitle">Add User</h3>

        <div class="form-row">
          <div class="col field">
            <label>Full name</label>
            <input id="m_fullName" placeholder="Full name" />
            <div id="m_fullName_msg" class="inline-msg"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="col field">
            <label>Username or email</label>
            <input id="m_username" placeholder="username (e.g. canab) or email (canab@gmail.com)" />
            <div id="m_username_msg" class="inline-msg"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="col field">
            <label>Type / Role</label>
            <select id="m_role">
              <option value="user">Normal user</option>
              <option value="controller">Controller</option>
              <option value="admin">Admin</option>
            </select>
            <div id="m_role_msg" class="inline-msg"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="col field">
            <label>Password</label>
            <input id="m_password" type="password" placeholder="Password (min 6 chars)"/>
            <div id="m_password_msg" class="inline-msg"></div>
          </div>
          <div class="col field">
            <label>Confirm password</label>
            <input id="m_password_confirm" type="password" placeholder="Confirm password"/>
            <div id="m_password_confirm_msg" class="inline-msg"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="m_cancel" class="small">Cancel</button>
          <button id="m_submit" class="small" style="background:var(--accent);color:#fff;border-color:var(--accent)">Create user</button>
        </div>
      </div>
    </div>
  `;
  modalWrap.style.display = 'block';

  // prefill
  if (prefill.fullName) document.getElementById('m_fullName').value = prefill.fullName;
  if (prefill.username) document.getElementById('m_username').value = prefill.username;
  if (prefill.role) document.getElementById('m_role').value = prefill.role;

  document.getElementById('m_cancel').onclick = closeAddUserModal;
  document.getElementById('addUserModalBackdrop').addEventListener('click', (e) => {
    if (e.target.id === 'addUserModalBackdrop') closeAddUserModal();
  });

  document.getElementById('m_submit').onclick = submitAddUser;
}

function closeAddUserModal() {
  modalWrap.innerHTML = '';
  modalWrap.style.display = 'none';
}

function validateAddUserForm({ fullName, username, role, password, confirm }) {
  const errors = {};
  if (!fullName || fullName.trim().length < 2) errors.fullName = 'Full name required';
  if (!username || username.trim().length < 3) errors.username = 'Username or email required (min 3 chars)';
  if (!role) errors.role = 'Select role';
  if (!password || password.length < 6) errors.password = 'Password min 6 chars';
  if (password !== confirm) errors.confirm = 'Passwords do not match';
  return errors;
}

async function submitAddUser() {
  const token = getToken();
  if (!token) return alert('Not authenticated as admin');

  const fullName = (document.getElementById('m_fullName').value || '').trim();
  const username = (document.getElementById('m_username').value || '').trim();
  const role = (document.getElementById('m_role').value || '').trim();
  const password = (document.getElementById('m_password').value || '');
  const confirm = (document.getElementById('m_password_confirm').value || '');

  // clear old messages
  ['m_fullName_msg','m_username_msg','m_role_msg','m_password_msg','m_password_confirm_msg'].forEach(id => {
    const el = document.getElementById(id); if (el) el.innerText = '';
  });

  const errs = validateAddUserForm({ fullName, username, role, password, confirm });
  if (Object.keys(errs).length) {
    if (errs.fullName) document.getElementById('m_fullName_msg').innerText = errs.fullName;
    if (errs.username) document.getElementById('m_username_msg').innerText = errs.username;
    if (errs.role) document.getElementById('m_role_msg').innerText = errs.role;
    if (errs.password) document.getElementById('m_password_msg').innerText = errs.password;
    if (errs.confirm) document.getElementById('m_password_confirm_msg').innerText = errs.confirm;
    return;
  }

  // prepare payload
  const payload = { username, fullName, password, role };

  // call admin API to create user
  const r = await fetchJson('/api/admin/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify(payload)
  });

  if (!r.ok) {
    // show server error inline if possible
    const msg = r.error || 'Create failed';
    // try to parse field errors
    if (r.data && r.data.error) {
      alert('Error: ' + r.data.error);
    } else {
      alert('Error: ' + msg);
    }
    return;
  }

  alert('User created successfully');
  closeAddUserModal();
  load();
}

// Wire Add button
document.getElementById('btnAddUser').addEventListener('click', () => openAddUserModal());

function escapeHtml(s){ if (s === 0) return '0'; if (!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

</script>
</body>
</html>
